machine:
  environment:
    GRADLE_OPTS: '-Dorg.gradle.jvmargs="-Xmx1024m -XX:+HeapDumpOnOutOfMemoryError"'
    XCODE_SCHEME: stock.goodcity
    XCODE_WORKSPACE: stock.goodcity
    GYM_CODE_SIGNING_IDENTITY: "iPhone Distribution: Crossroads Foundation Limited"
    FL_TESTFAIRY_AUTO_UPDATE: "on"
    PILOT_SKIP_SUBMISSION: true
    PILOT_WAIT_PROCESSING_INTERVAL: 60
    PATH: "${PATH}:${HOME}/${CIRCLE_PROJECT_REPONAME}/node_modules/.bin"

dependencies:
  cache_directories:
    - ~/.cache/yarn
  pre:
    - brew update
    - brew install homebrew/versions/node4-lts
    - brew install watchman
    - brew cask install android-sdk
    - echo y | android update sdk --no-ui --filter "tools" --use-sdk-wrapper
    - echo y | android update sdk --no-ui --filter "platform-tools" --use-sdk-wrapper
    # - echo y | android update sdk --no-ui --filter "extra-android-m2repository" --use-sdk-wrapper
    # - echo y | android update sdk --no-ui --filter "extra-google-m2repository" --use-sdk-wrapper
    - echo y | android update sdk --no-ui --filter "android-23" --use-sdk-wrapper
    - echo y | android update sdk --no-ui --filter "build-tools-23.0.1" --use-sdk-wrapper
    - export ANDROID_HOME=/usr/local/Caskroom/android-sdk/
    - export PATH=$ANDROID_HOME/build-tools/23.0.1:$PATH >> ~/.circlerc
    - curl -o- -L https://yarnpkg.com/install.sh | bash
    - yarn add --force node-sass
    - yarn add bower ember-cli phantomjs-prebuilt cordova
    - bundle install
    - gem update fastlane
  override:
    - yarn install
  post:
    - ./node_modules/bower/bin/bower install
    - PATH=$(npm bin):$PATH; azure-filestore download -f goodcity.keystore:
        pwd: cordova
    - PATH=$(npm bin):$PATH; azure-filestore download -d google-play -f $GOOGLE_PLAY_KEY_FILE:
        pwd: fastlane

test:
  pre:
    - ./node_modules/ember-cli/bin/ember server --port 4203:
        background: true
    - sleep 5
  override:
    - ./node_modules/ember-cli/bin/ember test
  post:
    - echo "Killing ember server to free memory for app build" && killall ember

deployment:
  staging:
    branch: GCW-1506-Update-android-sdk-to-fix-build
    commands:
      - bundle exec cap staging deploy
      - bundle exec rake staging ios app:build
      - fastlane ios staging
      - bundle exec rake staging android app:build
      - fastlane android staging

    branch: master
    commands:
      - bundle exec cap staging deploy
      - bundle exec rake staging ios app:build
      - fastlane ios staging
      - bundle exec rake staging android app:build
      - fastlane android staging
  production:
    branch: live
    commands:
      - bundle exec cap production deploy
      - bundle exec rake production android app:build
      - bundle exec rake production ios app:build
      - fastlane android beta
      - fastlane ios beta

